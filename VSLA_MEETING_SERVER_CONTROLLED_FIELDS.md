# VSLA Meeting Server-Controlled Fields

## Overview
When submitting VSLA meetings from the mobile app, certain fields are **controlled and validated server-side** to ensure data integrity and prevent inconsistencies.

## Server-Controlled Fields

### 1. **meeting_number**
- **Source**: Auto-generated by server
- **Logic**: Sequential numbering per group within cycle
- **Reason**: Prevents numbering conflicts from offline submissions
- **Mobile App**: Should NOT send this field

### 2. **cycle_id** 
- **Source**: Validated from request
- **Validation**:
  - Must exist in `projects` table
  - Must be a VSLA cycle (`is_vsla_cycle = 'Yes'`)
  - Must be active (`is_active_cycle = 'Yes'`)
- **Reason**: Ensures meetings only go to active VSLA cycles
- **Mobile App**: Sends cycle_id, server validates and may reject

### 3. **group_id**
- **Source**: Validated from request
- **Validation**:
  - Must exist in `ffs_groups` table
  - Must match the cycle's `group_id`
  - Must be VSLA type group
- **Reason**: Ensures group belongs to the cycle
- **Mobile App**: Sends group_id, server validates and may reject

### 4. **created_by_id**
- **Source**: Authenticated user ID
- **Logic**: `auth()->id()` or default to 1
- **Reason**: Tracks who submitted the meeting
- **Mobile App**: Should NOT send this field

### 5. **received_at**
- **Source**: Server timestamp (`now()`)
- **Logic**: Set when meeting is received by API
- **Reason**: Tracks server receipt time for audit trail
- **Mobile App**: Should NOT send this field

### 6. **processing_status**
- **Source**: Set to 'pending' initially
- **Logic**: Updated to 'processing' → 'completed'/'failed' by MeetingProcessingService
- **Reason**: Server manages processing workflow
- **Mobile App**: Should NOT send this field

### 7. **processed_at**
- **Source**: Set by MeetingProcessingService
- **Logic**: Timestamp when processing completes
- **Reason**: Tracks when meeting was fully processed
- **Mobile App**: Should NOT send this field

### 8. **processed_by_id**
- **Source**: Set by MeetingProcessingService
- **Logic**: ID of system/user that processed the meeting
- **Reason**: Audit trail for processing
- **Mobile App**: Should NOT send this field

### 9. **has_errors**
- **Source**: Set by MeetingProcessingService
- **Logic**: True if errors occurred during processing
- **Reason**: Server determines validation status
- **Mobile App**: Should NOT send this field

### 10. **has_warnings**
- **Source**: Set by MeetingProcessingService
- **Logic**: True if warnings occurred during processing
- **Reason**: Server determines validation status
- **Mobile App**: Should NOT send this field

### 11. **errors**
- **Source**: Set by MeetingProcessingService
- **Logic**: JSON array of error objects
- **Reason**: Server performs validation
- **Mobile App**: Should NOT send this field

### 12. **warnings**
- **Source**: Set by MeetingProcessingService
- **Logic**: JSON array of warning objects
- **Reason**: Server performs validation
- **Mobile App**: Should NOT send this field

## Fields Mobile App Should Send

The mobile app should send:
- `local_id` (unique offline identifier)
- `cycle_id` (for validation)
- `group_id` (for validation)
- `meeting_date`
- `notes`
- `members_present`
- `members_absent`
- `total_savings_collected`
- `total_welfare_collected`
- `total_social_fund_collected`
- `total_fines_collected`
- `total_loans_disbursed`
- `total_shares_sold`
- `total_share_value`
- `attendance_data` (array)
- `transactions_data` (array)
- `loans_data` (array)
- `share_purchases_data` (array)
- `previous_action_plans_data` (array)
- `upcoming_action_plans_data` (array)
- `submitted_from_app_at` (optional - app's submission time)

## API Response

The API returns server-controlled data in the response:

```json
{
  "success": true,
  "message": "Meeting processed successfully",
  "meeting_id": 123,
  "processing_status": "completed",
  "server_controlled_data": {
    "meeting_number": 5,
    "cycle_id": 10,
    "group_id": 25,
    "cycle_name": "2025 Cycle",
    "group_name": "Bukuya VSLA",
    "is_active_cycle": "Yes",
    "created_by_id": 1,
    "received_at": "2025-12-12 14:30:00"
  },
  "meeting_data": {
    "meeting_number": 5,
    "meeting_date": "2025-12-10",
    "total_members": 30,
    "attendance_rate": 90.0,
    "total_cash_collected": 150000,
    "net_cash_flow": 100000
  },
  "errors": [],
  "warnings": []
}
```

## Validation Errors

The API will reject submissions with clear error messages:

### Invalid Cycle
```json
{
  "success": false,
  "message": "Cycle is not a VSLA cycle"
}
```

### Inactive Cycle
```json
{
  "success": false,
  "message": "Cycle is not active. Cannot submit meetings to inactive cycles."
}
```

### Group-Cycle Mismatch
```json
{
  "success": false,
  "message": "Group does not belong to this cycle",
  "expected_group_id": 25,
  "provided_group_id": 30
}
```

### Non-VSLA Group
```json
{
  "success": false,
  "message": "Group is not a VSLA group"
}
```

## Benefits

1. **Data Integrity**: Server ensures consistent meeting numbering
2. **Validation**: Active cycles and correct group assignments enforced
3. **Audit Trail**: Server timestamps and user tracking
4. **Conflict Prevention**: Server-side number generation prevents duplicates
5. **Security**: Users cannot manipulate critical fields
6. **Workflow Control**: Processing status managed by server

## Implementation Status

✅ **Completed** (December 12, 2025)
- Server-side meeting number generation
- Cycle validation (VSLA type, active status)
- Group validation (type, cycle membership)
- Server timestamp management
- Enhanced API response with server-controlled data
- Form fields for is_vsla_cycle and is_active_cycle in admin panel
